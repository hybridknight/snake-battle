<html> 
<head> 
<title>Snake Battle (Alpha)</title>
<style>

#map1 {
  width:600px;
  height:400px;
  position:relative;
  border:1px solid #aaa;
  overflow:hidden;
  text-align:center;
}

#map {
  position:absolute;
  left:0;
  width:100%;
  line-height:1;
  display:block;
  font-size:200%;
  z-index:101;
  text-align:center;
}
.snake, .wall {
  width:10px;
  height:10px;
  position:absolute;
  z-index:99;
  display:block;
  white-space:nowrap;
  overflow:hidden;
}
.snake {
  background:red;
}

.right {float:right}
.error {color:red}
.hidden {display:none}

</style>
</head> 
 
<body>
<div id="map1">
  <div id="map"></div>
</div>
<div id="control">
	<input type="button" value="up" class="direction 0"/>
	<input type="button" value="down" class="direction 2"/>
	<input type="button" value="left" class="direction 3"/>
	<input type="button" value="right" class="direction 1"/>
	<div class="snakesList"></div>
	
</div>

<div id="code">
	<input type="button" value="submit code" class="submitCode"/>
	<input type="button" value="save code" class="saveCode"/>
	<div>
		<textarea class="codeArea" cols="80" rows="40"></textarea>
	</div>
</div>

<div id="mapText"></div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script> 
<script src="/nowjs/now.js"></script>

<script>
$(document).ready(function(){
  var code = '';
  
  now.name = new Date().getTime();
  now.drawMap = function(map){
  	setSnakeList(map.snakes);
    var mapArray = renderMap(map);
    trigger(mapArray);
  }
  function setSnakeList(list){
  	$('div.snakesList').html('');
  	var num = 0;
  	for(var i in list){
  		var snake = list[i];
  		var name = snake.name == now.name ? '------YOU------' : snake.name;
  		name = snake.die ? '<s>' + name + '</s>' : name;
  		$('div.snakesList')
  		.append('<span style="background:'
  		+ snake.color + '">' + name + '</span>');
  		if(++num % 6 == 0){
  			$('div.snakesList')
  		.append('<br/>');
  		}
  	}
  }
    
  function renderMap(map){
    var width = map.width;
    var height = map.height;
    var snakes = map.snakes;
    
    var mapArray = [];
    for(var y = 0; y < height; y++){
    	mapArray[y] = [];
    	for(var x = 0; x < width; x++){
    		mapArray[y][x] = null;
    	}
    }
    
    $('div#map').html('');
    var $map = $('div#map');
    for(var i in snakes){
      var snake = snakes[i];
      for(var j in snake.body){
        var segment = snake.body[j];
        $('<span class="snake '+snake.name + ' ' + j +'"></span>')
        .appendTo($map)
        .css({
        	top:(segment.y*10)+"px",
        	left:(segment.x*10)+"px",
        	display:"block",
        	background:snake.color
        	});
        mapArray[segment.y][segment.x] = snake;
      }
    }
    
    //drawMapText(mapArray);
    return {
    	width: width,
    	height: height,
    	mapArray: mapArray,
    	snakes: snakes
    }
  }
  
  function drawMapText(mapArray){
  	var text = '';
  	for(var y in mapArray){
  		for(var x in mapArray[y]){
  			if(mapArray[y][x]){
  				if(mapArray[y][x].name == now.name){
  					text += 'y';
  				}else{
  					text += 'x';
  				}
   			}else{
  				text += '. ';
  			}
  		}
  		text += '<br/>';
  	}
  	$('div#mapText').html(text);;
  }
  
  function trigger(map){
  	Map = map;
  	eval(code);
  }
  
  function setDirection(direction){
  	now.setDirection(direction);
  }
  
  // load code
  (function loadCode(){
  	code = localStorage.getItem('code');
  	$('textarea.codeArea').val(code);
  })();
  
  
  $('input.submitCode').unbind('click').click(function submitCode(){
  	code = $('textarea.codeArea').val();
  	console.log('code submitted:');
  	console.log(code);
  	eval(code);
  });
  
  $('input.saveCode').unbind('click').click(function saveCode(){
  	code = $('textarea.codeArea').val();
  	localStorage.setItem('code', code);
  	console.log('code saved:');
  	console.log(code);
  });
  
  $('input.direction').unbind('click').click(function clickDirection(){
  	now.setDirection($(this).attr('class').split(' ')[1]);
  });
});
</script>
</body> 
</html> 