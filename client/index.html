<html> 
<head> 
<title>Snake Battle (Alpha)</title>
<style>

#map1 {
  width:900px;
  height:400px;
  position:relative;
  border:1px solid #aaa;
  overflow:hidden;
  text-align:center;
}

#map {
  position:absolute;
  left:0;
  width:100%;
  line-height:1;
  display:block;
  font-size:200%;
  z-index:101;
  text-align:center;
}
.snake, .wall, .cherry{
  width:10px;
  height:10px;
  position:absolute;
  z-index:99;
  display:block;
  white-space:nowrap;
  overflow:hidden;
}
.snake {
  background:red;
}

.cherry {
  background:red;
}

.right {float:right}
.error {color:red}
.hidden {display:none}

</style>
</head> 
 
<body>
<div id="control">
  <table>
    <tr>
      <td></td>
      <td><input type="button" value="u" class="direction 0"/></td>
      <td></td>
    </tr>
    <tr>
      <td><input type="button" value="l" class="direction 3"/></td>
      <td></td>
      <td><input type="button" value="r" class="direction 1"/></td>
    </tr>
    <tr>
      <td></td>
      <td><input type="button" value="d" class="direction 2"/></td>
      <td></td>
    </tr>
  </table>
  <div class="snakesList"></div>
  <div>
    <input type="button" value="set your name" class="setName"/> - set your name
  </div>
</div>
<div id="map1">
  <div id="map"></div>
</div>
<div id="code">
	<input type="button" value="submit code" class="submitCode"/> - run following code !
	<input type="button" value="save code" class="saveCode"/> - save this code in browser
	<div>
		<textarea class="codeArea" cols="80" rows="40"></textarea>
	</div>
</div>
<div id="instruction">
  You can access these variables and methods.
  <ul>
    <li><b>Store</b> - your private Store</li>
    <li><b>Map</b> - Map object</li>
    <li>
      <b>setDirection(direction)</b> - set the direction of your snake
      <ul>
        <li>direction = 0 - up</li>
        <li>direction = 1 - right</li>
        <li>direction = 2 - down</li>
        <li>direction = 3 - left</li>
      </ul>
    </li>
  </ul>
</div>
<div id="mapText"></div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script> 
<script src="/nowjs/now.js"></script>

<script>
$(document).ready(function(){
  var code = '';
  
  now.name = localStorage.getItem('name') || new Date().getTime();
  now.drawMap = function(map){
  	setSnakeList(map.snakes);
    var mapArray = renderMap(map);
    trigger(mapArray);
  }
  function setSnakeList(list){
  	$('div.snakesList').html('');
  	var num = 0;
  	for(var i in list){
  		var snake = list[i];
  		var name = snake.name == now.name ? 
  		'<b><u>' + snake.name + ' (' + snake.score + ')</u></b>' : snake.name + ' (' + snake.score + ')';
  		name = snake.die ? '<s>' + name + '</s>' : name;
  		$('div.snakesList')
  		.append('<span style="background:'
  		+ snake.color + '">' + name + '</span>');
  		if(++num % 6 == 0){
  			$('div.snakesList')
  		.append('<br/>');
  		}
  	}
  }
    
  function renderMap(map){
    var width = map.width;
    var height = map.height;
    var snakes = map.snakes;
    var cherries = map.cherries;
    
    var mapArray = [];
    for(var y = 0; y < height; y++){
    	mapArray[y] = [];
    	for(var x = 0; x < width; x++){
    		mapArray[y][x] = null;
    	}
    }
    
    $('div#map').html('');
    var $map = $('div#map');
    for(var i in snakes){
      var snake = snakes[i];
      for(var j in snake.body){
        var segment = snake.body[j];
        $('<span class="snake '+snake.name + ' ' + j +'"></span>')
        .appendTo($map)
        .css({
        	top:(segment.y*10)+"px",
        	left:(segment.x*10)+"px",
        	display:"block",
        	background:snake.color
        	});
        mapArray[segment.y][segment.x] = snake;
      }
    }
    
    for(var i in cherries){
      var cherry = cherries[i];
      $('<span class="cherry '+cherry.color +' ' + cherry.cherryNo + '"></span>')
        .appendTo($map)
        .css({
          top:(cherry.y*10)+"px",
          left:(cherry.x*10)+"px",
          display:"block",
          background:cherry.color
          });
        mapArray[cherry.y][cherry.x] = cherry;
    }
    //drawMapText(mapArray);
    return {
    	width: width,
    	height: height,
    	mapArray: mapArray,
    	snakes: snakes,
    	cherries: cherries
    }
  }
  
  function drawMapText(mapArray){
  	var text = '';
  	for(var y in mapArray){
  		for(var x in mapArray[y]){
  			if(mapArray[y][x]){
  				if(mapArray[y][x].name == now.name){
  					text += 'y';
  				}else{
  					text += 'x';
  				}
   			}else{
  				text += '. ';
  			}
  		}
  		text += '<br/>';
  	}
  	$('div#mapText').html(text);;
  }
  
  function trigger(map){
  	Map = map;
  	if('undefined' === typeof Store){
  	 Store = {};
  	}
  	
  	eval(code);
  }
  
  function setDirection(direction){
  	now.setDirection(direction);
  }
  
  // load code
  (function loadCode(){
  	code = localStorage.getItem('code');
  	
  	if(!(code && code.length > 0)){
  	  code = "// random direction"
      +"\nvar direction = Math.floor(Math.random()*4);"
      +"\n// set direction of snake"
      +"\nsetDirection(direction);";
  	}
  	
  	$('textarea.codeArea').val(code);
  })();
  
  
  $('input.submitCode').unbind('click').click(function submitCode(){
  	code = $('textarea.codeArea').val();
  	console.log('code submitted:');
  	console.log(code);
  	eval(code);
  });
  
  $('input.saveCode').unbind('click').click(function saveCode(){
  	code = $('textarea.codeArea').val();
  	localStorage.setItem('code', code);
  	console.log('code saved:');
  	console.log(code);
  });
  
  $('input.setName').unbind('click').click(function submitCode(){
    var oldName = now.name;
    var newName = prompt("What's your name?", "");
    now.setName(oldName, newName);
    localStorage.setItem('name', newName)
  });
  
  $('input.direction').unbind('click').click(function clickDirection(){
  	now.setDirection($(this).attr('class').split(' ')[1]);
  });
});
</script>
</body> 
</html> 